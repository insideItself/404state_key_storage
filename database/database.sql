DROP TABLE IF EXISTS outline_server CASCADE;
DROP TABLE IF EXISTS server_location CASCADE;
DROP TABLE IF EXISTS server_provider CASCADE;
DROP TABLE IF EXISTS outline_server_info CASCADE;
DROP TABLE IF EXISTS dynamic_key CASCADE;
DROP TABLE IF EXISTS outline_key CASCADE;

CREATE TABLE outline_server (
    id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    hostname VARCHAR NOT NULL,
    port INTEGER NOT NULL,
    api_url VARCHAR NOT NULL,
    is_active BOOLEAN NOT NULL
);

CREATE TABLE server_location (
    id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    location VARCHAR NOT NULL UNIQUE,
    location_ru VARCHAR NOT NULL UNIQUE,
    iso CHAR(2) CONSTRAINT iso_check CHECK (iso ~ '^[A-Z]{2}$') UNIQUE
);

CREATE TABLE server_provider (
    id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    provider VARCHAR NOT NULL
);

CREATE TABLE outline_server_info (
    fk_outline_server_id INTEGER NOT NULL,
    fk_server_location_id INTEGER NOT NULL,
    fk_server_provider_id INTEGER NOT NULL,

    FOREIGN KEY (fk_outline_server_id) REFERENCES outline_server (id),
    FOREIGN KEY (fk_server_location_id) REFERENCES server_location (id),
    FOREIGN KEY (fk_server_provider_id) REFERENCES server_provider (id)
);

CREATE TABLE outline_key (
    uuid UUID PRIMARY KEY,
    id INTEGER NOT NULL,
    fk_outline_server_id INTEGER NOT NULL,
    access_url VARCHAR NOT NULL,
    currently_used BOOLEAN NOT NULL,

    FOREIGN KEY (fk_outline_server_id) REFERENCES outline_server (id)
);

CREATE TABLE dynamic_key (
    id VARCHAR(9) CHECK (CHAR_LENGTH(id) = 9) PRIMARY KEY,
    tg_user_id BIGINT NOT NULL,
    server VARCHAR NOT NULL,
    server_port INTEGER NOT NULL,
    password VARCHAR NOT NULL,
    method VARCHAR NOT NULL,
    is_active BOOLEAN NOT NULL,
    fk_outline_key_uuid UUID NOT NULL,

    FOREIGN KEY (fk_outline_key_uuid) REFERENCES outline_key (uuid)
);

ALTER SEQUENCE outline_server_id_seq RESTART WITH 1;
ALTER SEQUENCE server_location_id_seq RESTART WITH 1;
ALTER SEQUENCE server_provider_id_seq RESTART WITH 1;

-- Index on fk_outline_server_id
CREATE INDEX IF NOT EXISTS idx_outline_key_server_id ON outline_key (fk_outline_server_id);

-- Partial index on currently_used when true
CREATE INDEX IF NOT EXISTS idx_outline_key_currently_used_true ON outline_key (fk_outline_server_id)
WHERE currently_used = true;

-- Partial index on currently_used when false
CREATE INDEX IF NOT EXISTS idx_outline_key_currently_used_false ON outline_key (fk_outline_server_id)
WHERE currently_used = false;

-- Insert location information
INSERT INTO server_location (location, location_ru, iso) VALUES
('Ascension Island', 'Остров Вознесения', 'AC'),
('Andorra', 'Андорра', 'AD'),
('United Arab Emirates', 'Объединенные Арабские Эмираты', 'AE'),
('Afghanistan', 'Афганистан', 'AF'),
('Antigua & Barbuda', 'Антигуа и Барбуда', 'AG'),
('Anguilla', 'Ангилья', 'AI'),
('Albania', 'Албания', 'AL'),
('Armenia', 'Армения', 'AM'),
('Angola', 'Ангола', 'AO'),
('Antarctica', 'Антарктика', 'AQ'),
('Argentina', 'Аргентина', 'AR'),
('American Samoa', 'Американское Самоа', 'AS'),
('Austria', 'Австрия', 'AT'),
('Australia', 'Австралия', 'AU'),
('Aruba', 'Аруба', 'AW'),
('Åland Islands', 'Аландские острова', 'AX'),
('Azerbaijan', 'Азербайджан', 'AZ'),
('Bosnia & Herzegovina', 'Босния и Герцеговина', 'BA'),
('Barbados', 'Барбадос', 'BB'),
('Bangladesh', 'Бангладеш', 'BD'),
('Belgium', 'Бельгия', 'BE'),
('Burkina Faso', 'Буркина-Фасо', 'BF'),
('Bulgaria', 'Болгария', 'BG'),
('Bahrain', 'Бахрейн', 'BH'),
('Burundi', 'Бурунди', 'BI'),
('Benin', 'Бенин', 'BJ'),
('St. Barthélemy', 'Сен-Бартелеми', 'BL'),
('Bermuda', 'Бермудские острова', 'BM'),
('Brunei', 'Бруней', 'BN'),
('Bolivia', 'Боливия', 'BO'),
('Caribbean Netherlands', 'Карибские Нидерланды', 'BQ'),
('Brazil', 'Бразилия', 'BR'),
('Bahamas', 'Багамские Острова', 'BS'),
('Bhutan', 'Бутан', 'BT'),
('Bouvet Island', 'Остров Буве', 'BV'),
('Botswana', 'Ботсвана', 'BW'),
('Belarus', 'Беларусь', 'BY'),
('Belize', 'Белиз', 'BZ'),
('Canada', 'Канада', 'CA'),
('Cocos (Keeling) Islands', 'Кокосовые острова', 'CC'),
('Congo - Kinshasa', 'Конго - Киншаса', 'CD'),
('Central African Republic', 'Центральноафриканская Республика', 'CF'),
('Congo - Brazzaville', 'Конго - Браззавиль', 'CG'),
('Switzerland', 'Швейцария', 'CH'),
('Côte d’Ivoire', 'Кот-д’Ивуар', 'CI'),
('Cook Islands', 'Острова Кука', 'CK'),
('Chile', 'Чили', 'CL'),
('Cameroon', 'Камерун', 'CM'),
('China', 'Китай', 'CN'),
('Colombia', 'Колумбия', 'CO'),
('Clipperton Island', 'Остров Клиппертон', 'CP'),
('Costa Rica', 'Коста-Рика', 'CR'),
('Cuba', 'Куба', 'CU'),
('Cape Verde', 'Кабо-Верде', 'CV'),
('Curaçao', 'Кюрасао', 'CW'),
('Christmas Island', 'Остров Рождества', 'CX'),
('Cyprus', 'Кипр', 'CY'),
('Czechia', 'Чехия', 'CZ'),
('Germany', 'Германия', 'DE'),
('Diego Garcia', 'Диего-Гарсия', 'DG'),
('Djibouti', 'Джибути', 'DJ'),
('Denmark', 'Дания', 'DK'),
('Dominica', 'Доминика', 'DM'),
('Dominican Republic', 'Доминиканская Республика', 'DO'),
('Algeria', 'Алжир', 'DZ'),
('Ceuta & Melilla', 'Сеута и Мелилья', 'EA'),
('Ecuador', 'Эквадор', 'EC'),
('Estonia', 'Эстония', 'EE'),
('Egypt', 'Египет', 'EG'),
('Western Sahara', 'Западная Сахара', 'EH'),
('Eritrea', 'Эритрея', 'ER'),
('Spain', 'Испания', 'ES'),
('Ethiopia', 'Эфиопия', 'ET'),
('European Union', 'Европейский Союз', 'EU'),
('Finland', 'Финляндия', 'FI'),
('Fiji', 'Фиджи', 'FJ'),
('Falkland Islands', 'Фолклендские острова', 'FK'),
('Micronesia', 'Микронезия', 'FM'),
('Faroe Islands', 'Фарерские острова', 'FO'),
('France', 'Франция', 'FR'),
('Gabon', 'Габон', 'GA'),
('United Kingdom', 'Великобритания', 'GB'),
('Grenada', 'Гренада', 'GD'),
('Georgia', 'Грузия', 'GE'),
('French Guiana', 'Французская Гвиана', 'GF'),
('Guernsey', 'Гернси', 'GG'),
('Ghana', 'Гана', 'GH'),
('Gibraltar', 'Гибралтар', 'GI'),
('Greenland', 'Гренландия', 'GL'),
('Gambia', 'Гамбия', 'GM'),
('Guinea', 'Гвинея', 'GN'),
('Guadeloupe', 'Гваделупа', 'GP'),
('Equatorial Guinea', 'Экваториальная Гвинея', 'GQ'),
('Greece', 'Греция', 'GR'),
('South Georgia & South Sandwich Islands', 'Южная Георгия и Южные Сандвичевы острова', 'GS'),
('Guatemala', 'Гватемала', 'GT'),
('Guam', 'Гуам', 'GU'),
('Guinea-Bissau', 'Гвинея-Бисау', 'GW'),
('Guyana', 'Гайана', 'GY'),
('Hong Kong SAR China', 'Гонконг, Китай', 'HK'),
('Heard & McDonald Islands', 'Острова Херд и Макдональд', 'HM'),
('Honduras', 'Гондурас', 'HN'),
('Croatia', 'Хорватия', 'HR'),
('Haiti', 'Гаити', 'HT'),
('Hungary', 'Венгрия', 'HU'),
('Canary Islands', 'Канарские острова', 'IC'),
('Indonesia', 'Индонезия', 'ID'),
('Ireland', 'Ирландия', 'IE'),
('Israel', 'Израиль', 'IL'),
('Isle of Man', 'Остров Мэн', 'IM'),
('India', 'Индия', 'IN'),
('British Indian Ocean Territory', 'Британская территория в Индийском океане', 'IO'),
('Iraq', 'Ирак', 'IQ'),
('Iran', 'Иран', 'IR'),
('Iceland', 'Исландия', 'IS'),
('Italy', 'Италия', 'IT'),
('Jersey', 'Джерси', 'JE'),
('Jamaica', 'Ямайка', 'JM'),
('Jordan', 'Иордания', 'JO'),
('Japan', 'Япония', 'JP'),
('Kenya', 'Кения', 'KE'),
('Kyrgyzstan', 'Киргизия', 'KG'),
('Cambodia', 'Камбоджа', 'KH'),
('Kiribati', 'Кирибати', 'KI'),
('Comoros', 'Коморы', 'KM'),
('St. Kitts & Nevis', 'Сент-Китс и Невис', 'KN'),
('North Korea', 'Северная Корея', 'KP'),
('South Korea', 'Южная Корея', 'KR'),
('Kuwait', 'Кувейт', 'KW'),
('Cayman Islands', 'Каймановы острова', 'KY'),
('Kazakhstan', 'Казахстан', 'KZ'),
('Laos', 'Лаос', 'LA'),
('Lebanon', 'Ливан', 'LB'),
('St. Lucia', 'Сент-Люсия', 'LC'),
('Liechtenstein', 'Лихтенштейн', 'LI'),
('Sri Lanka', 'Шри-Ланка', 'LK'),
('Liberia', 'Либерия', 'LR'),
('Lesotho', 'Лесото', 'LS'),
('Lithuania', 'Литва', 'LT'),
('Luxembourg', 'Люксембург', 'LU'),
('Latvia', 'Латвия', 'LV'),
('Libya', 'Ливия', 'LY'),
('Morocco', 'Марокко', 'MA'),
('Monaco', 'Монако', 'MC'),
('Moldova', 'Молдова', 'MD'),
('Montenegro', 'Черногория', 'ME'),
('St. Martin', 'Сен-Мартен', 'MF'),
('Madagascar', 'Мадагаскар', 'MG'),
('Marshall Islands', 'Маршалловы Острова', 'MH'),
('North Macedonia', 'Северная Македония', 'MK'),
('Mali', 'Мали', 'ML'),
('Myanmar (Burma)', 'Мьянма (Бирма)', 'MM'),
('Mongolia', 'Монголия', 'MN'),
('Macao SAR China', 'Макао, Китай', 'MO'),
('Northern Mariana Islands', 'Северные Марианские острова', 'MP'),
('Martinique', 'Мартиника', 'MQ'),
('Mauritania', 'Мавритания', 'MR'),
('Montserrat', 'Монтсеррат', 'MS'),
('Malta', 'Мальта', 'MT'),
('Mauritius', 'Маврикий', 'MU'),
('Maldives', 'Мальдивы', 'MV'),
('Malawi', 'Малави', 'MW'),
('Mexico', 'Мексика', 'MX'),
('Malaysia', 'Малайзия', 'MY'),
('Mozambique', 'Мозамбик', 'MZ'),
('Namibia', 'Намибия', 'NA'),
('New Caledonia', 'Новая Каледония', 'NC'),
('Niger', 'Нигер', 'NE'),
('Norfolk Island', 'Остров Норфолк', 'NF'),
('Nigeria', 'Нигерия', 'NG'),
('Nicaragua', 'Никарагуа', 'NI'),
('Netherlands', 'Нидерланды', 'NL'),
('Norway', 'Норвегия', 'NO'),
('Nepal', 'Непал', 'NP'),
('Nauru', 'Науру', 'NR'),
('Niue', 'Ниуэ', 'NU'),
('New Zealand', 'Новая Зеландия', 'NZ'),
('Oman', 'Оман', 'OM'),
('Panama', 'Панама', 'PA'),
('Peru', 'Перу', 'PE'),
('French Polynesia', 'Французская Полинезия', 'PF'),
('Papua New Guinea', 'Папуа - Новая Гвинея', 'PG'),
('Philippines', 'Филиппины', 'PH'),
('Pakistan', 'Пакистан', 'PK'),
('Poland', 'Польша', 'PL'),
('St. Pierre & Miquelon', 'Сен-Пьер и Микелон', 'PM'),
('Pitcairn Islands', 'Острова Питкэрн', 'PN'),
('Puerto Rico', 'Пуэрто-Рико', 'PR'),
('Palestinian Territories', 'Палестинские территории', 'PS'),
('Portugal', 'Португалия', 'PT'),
('Palau', 'Палау', 'PW'),
('Paraguay', 'Парагвай', 'PY'),
('Qatar', 'Катар', 'QA'),
('Réunion', 'Реюньон', 'RE'),
('Romania', 'Румыния', 'RO'),
('Serbia', 'Сербия', 'RS'),
('Russia', 'Россия', 'RU'),
('Rwanda', 'Руанда', 'RW'),
('Saudi Arabia', 'Саудовская Аравия', 'SA'),
('Solomon Islands', 'Соломоновы Острова', 'SB'),
('Seychelles', 'Сейшельские Острова', 'SC'),
('Sudan', 'Судан', 'SD'),
('Sweden', 'Швеция', 'SE'),
('Singapore', 'Сингапур', 'SG'),
('St. Helena', 'Остров Святой Елены', 'SH'),
('Slovenia', 'Словения', 'SI'),
('Svalbard & Jan Mayen', 'Шпицберген и Ян-Майен', 'SJ'),
('Slovakia', 'Словакия', 'SK'),
('Sierra Leone', 'Сьерра-Леоне', 'SL'),
('San Marino', 'Сан-Марино', 'SM'),
('Senegal', 'Сенегал', 'SN'),
('Somalia', 'Сомали', 'SO'),
('Suriname', 'Суринам', 'SR'),
('South Sudan', 'Южный Судан', 'SS'),
('São Tomé & Príncipe', 'Сан-Томе и Принсипи', 'ST'),
('El Salvador', 'Сальвадор', 'SV'),
('Sint Maarten', 'Синт-Мартен', 'SX'),
('Syria', 'Сирия', 'SY'),
('Eswatini', 'Эсватини', 'SZ'),
('Tristan da Cunha', 'Тристан-да-Кунья', 'TA'),
('Turks & Caicos Islands', 'Острова Теркс и Кайкос', 'TC'),
('Chad', 'Чад', 'TD'),
('French Southern Territories', 'Французские Южные территории', 'TF'),
('Togo', 'Того', 'TG'),
('Thailand', 'Таиланд', 'TH'),
('Tajikistan', 'Таджикистан', 'TJ'),
('Tokelau', 'Токелау', 'TK'),
('Timor-Leste', 'Восточный Тимор', 'TL'),
('Turkmenistan', 'Туркменистан', 'TM'),
('Tunisia', 'Тунис', 'TN'),
('Tonga', 'Тонга', 'TO'),
('Turkey', 'Турция', 'TR'),
('Trinidad & Tobago', 'Тринидад и Тобаго', 'TT'),
('Tuvalu', 'Тувалу', 'TV'),
('Taiwan', 'Тайвань', 'TW'),
('Tanzania', 'Танзания', 'TZ'),
('Ukraine', 'Украина', 'UA'),
('Uganda', 'Уганда', 'UG'),
('U.S. Outlying Islands', 'Внешние малые острова США', 'UM'),
('USA', 'США', 'US'),
('Uruguay', 'Уругвай', 'UY'),
('Uzbekistan', 'Узбекистан', 'UZ'),
('Vatican City', 'Ватикан', 'VA'),
('St. Vincent & Grenadines', 'Сент-Винсент и Гренадины', 'VC'),
('Venezuela', 'Венесуэла', 'VE'),
('British Virgin Islands', 'Британские Виргинские острова', 'VG'),
('U.S. Virgin Islands', 'Виргинские острова США', 'VI'),
('Vietnam', 'Вьетнам', 'VN'),
('Vanuatu', 'Вануату', 'VU'),
('Wallis & Futuna', 'Уоллис и Футуна', 'WF'),
('Samoa', 'Самоа', 'WS'),
('Kosovo', 'Косово', 'XK'),
('Yemen', 'Йемен', 'YE'),
('Mayotte', 'Майотта', 'YT'),
('South Africa', 'Южно-Африканская Республика', 'ZA'),
('Zambia', 'Замбия', 'ZM'),
('Zimbabwe', 'Зимбабве', 'ZW');
